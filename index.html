<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Editor ZIP & Folder â€” Demo</title>

<!-- Font Awesome + CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/dracula.min.css"/>

<style>
/* === STYLING SAMA SEPERTI SEBELUMNYA === */
:root{
  --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  --activity-bar-bg:#333;
  --sidebar-bg:#252526;
  --editor-bg:#1e1e1e;
  --status-bar-bg:#007acc;
  --border-color:#3e3e42;
  --text-primary:#cccccc;
  --text-secondary:#808080;
  --list-hover-bg:#2a2d2e;
  --list-active-bg:#37373d;
  --accent-blue:#007acc;
  --tab-inactive-bg:#2d2d2d;
  --tab-active-bg:var(--editor-bg);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:var(--font-family);
  background:var(--editor-bg);
  color:var(--text-primary);
  display:flex;
  flex-direction:column;
  height:100vh;
  overflow:hidden;
}
.main-container{display:flex;flex:1;min-height:0}
.activity-bar{
  width:48px;background:var(--activity-bar-bg);display:flex;flex-direction:column;justify-content:space-between;align-items:center;padding:10px 0;flex-shrink:0;z-index:101
}
.activity-bar .actions-group{display:flex;flex-direction:column;gap:10px;width:100%}
.icon-btn{color:var(--text-secondary);background:none;border:none;font-size:18px;padding:8px;cursor:pointer;width:100%}
.icon-btn:hover{color:var(--text-primary)}
.sidebar{width:260px;background:var(--sidebar-bg);display:flex;flex-direction:column;transition:width .18s ease;flex-shrink:0}
.sidebar.collapsed{width:0;padding:0;border-right:none;overflow:hidden}
.sidebar-header{padding:10px 12px;font-size:12px;color:var(--text-secondary);text-transform:uppercase;display:flex;align-items:center;gap:8px}
.file-tree{flex:1;overflow:auto;padding:6px 8px;font-size:14px;min-height:0}
.file-tree ul{list-style:none;margin:0;padding:0}
.file-tree ul.nested{padding-left:12px}
.file-tree ul.collapsed{display:none}
.tree-item{padding:6px 8px;border-radius:4px;cursor:pointer;display:flex;align-items:center;gap:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tree-item:hover{background:var(--list-hover-bg)}
.tree-item.active{background:var(--list-active-bg)}
.folder-toggle{width:14px;text-align:center;transition:transform .15s}
.folder-toggle.expanded{transform:rotate(90deg)}
.workbench{flex:1;display:flex;flex-direction:column;min-width:0}
.editor-area{flex:1;display:flex;flex-direction:column;min-height:0}
.editor-tabs{display:flex;background:var(--tab-inactive-bg);flex-shrink:0;overflow-x:auto;align-items:center;padding:4px}
.editor-tabs .btn{
  background:var(--tab-inactive-bg);
  border:none;
  border-right:1px solid var(--border-color);
  padding:6px 8px;
  white-space:nowrap;
  color:var(--text-primary);
  display:inline-flex;
  align-items:center;
  gap:8px;
  position: relative;
  user-select:none;
  border-radius:4px;
  margin-right:6px;
}
.editor-tabs .btn.active{background:var(--tab-active-bg); box-shadow: inset 0 -3px 0 rgba(0,0,0,0.2)}
.editor-tabs .btn .filename { max-width:160px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; display:inline-block; vertical-align:middle; }
.editor-tabs .btn .close-btn {
  font-weight: bold;
  cursor: pointer;
  padding: 0 6px;
  color: var(--text-secondary);
  font-size: 14px;
  line-height: 1;
  user-select:none;
  border-radius:3px;
  background:transparent;
  border:none;
}
.editor-tabs .btn .close-btn:hover {
  color: #ff7777;
  background: rgba(255,255,255,0.02);
}
.editor-wrap{flex:1;display:flex;min-height:0;position:relative}
.cm-container{flex:1;position:relative;min-height:0}
.CodeMirror{position:absolute;inset:0;height:100%!important;background:transparent!important;color:var(--text-primary);font-family:monospace}
.CodeMirror-scroll{background:transparent!important}
.CodeMirror-gutters{background:transparent!important;border-right:1px solid var(--border-color)}
.cm-s-dracula .CodeMirror-linebackground{background:transparent!important}
.image-preview-area{display:none;position:absolute;inset:0;background-color:var(--editor-bg);padding:20px;align-items:center;justify-content:center}
.image-preview-area.active{display:flex}
.image-preview-area img{max-width:100%;max-height:100%;object-fit:contain}
.status-bar{height:28px;background:var(--status-bar-bg);color:white;display:flex;align-items:center;justify-content:space-between;padding:0 12px;font-size:13px;flex-shrink:0}
.status-actions{display:flex;gap:8px;align-items:center}
#preview-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:2000;padding:3vh 4vw;align-items:center;justify-content:center}
#preview-overlay.active{display:flex}
.preview-modal{width:100%;height:100%;background:var(--sidebar-bg);border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.3);display:flex;flex-direction:column;overflow:hidden}
.preview-header{padding:8px 12px;display:flex;align-items:center;border-bottom:1px solid var(--border-color);font-weight:600}
.preview-header .close-btn{margin-left:auto;background:none;border:none;color:var(--text-primary);font-size:20px;cursor:pointer}
.preview-content{flex:1}
iframe.preview{width:100%;height:100%;border:none;background:white}
.folder-name{font-weight:600;color:var(--text-secondary);padding:6px 8px;border-radius:4px}
.file-ext{font-size:12px;color:var(--text-secondary);padding-left:6px}
.small-muted{font-size:12px;color:var(--text-secondary)}
@media (max-width:768px){
  .sidebar{position:fixed;height:100vh;z-index:100;left:48px;margin-left:-100%}
  .sidebar.visible{margin-left:0;width:calc(100% - 48px);max-width:340px}
  .sidebar.collapsed {
    margin-left: -100%;}
  .status-bar{display:none}
}
.btn-primary{background:var(--accent-blue);color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer}
.btn-ghost{background:transparent;color:var(--text-primary);border:1px solid rgba(255,255,255,0.04);padding:6px 10px;border-radius:4px;cursor:pointer}
</style>
</head>
<body>

<div class="main-container">
  <aside class="activity-bar">
    <div class="actions-group">
      <!-- Tombol Explorer -->
      <button id="toggle-explorer" class="icon-btn" title="Explorer"><i class="fa-solid fa-sitemap"></i></button>
      <label for="folder-input" class="icon-btn" title="Import Folder"><i class="fa-solid fa-folder-plus"></i></label>
      <label for="zip-input" class="icon-btn" title="Import ZIP"><i class="fa-solid fa-file-zipper"></i></label>
      <button id="run-btn-activity" class="icon-btn" title="Run Preview"><i class="fa-solid fa-play"></i></button>
    </div>
    <div class="actions-group">
      <button id="clear-btn" class="icon-btn" title="Clear All"><i class="fa-solid fa-trash"></i></button>
    </div>
  </aside>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <span>Explorer</span>
      <button id="collapse-sidebar" class="icon-btn" title="Toggle" style="margin-left:auto"><i class="fa-solid fa-chevron-left"></i></button>
    </div>
    <div class="file-tree" id="file-tree">(kosong)</div>
    <div style="padding:8px;border-top:1px solid var(--border-color);font-size:12px;color:var(--text-secondary)">
      <div class="small-muted">Imported files: <span id="file-count">0</span></div>
    </div>
  </aside>

  <div class="workbench">
    <main class="editor-area">
      <div class="editor-tabs" id="editor-tabs"></div>
      <div class="editor-wrap">
        <div class="cm-container" id="cm-container">
          <textarea id="code-editor"></textarea>
        </div>
        <div class="image-preview-area" id="image-preview-area">
          <img id="image-preview-img" src="" alt="Image Preview"/>
        </div>
      </div>
    </main>
    <div class="status-bar">
      <div class="status-info">Project: memory</div>
      <div class="status-actions">
        <button id="save-file" class="btn-ghost" title="Save file"><i class="fa-solid fa-save"></i> Save</button>
        <input id="folder-input" type="file" webkitdirectory multiple hidden />
        <input id="zip-input" type="file" accept=".zip" hidden />
      </div>
    </div>
  </div>
</div>

<!-- Preview modal -->
<div id="preview-overlay">
  <div class="preview-modal">
    <div class="preview-header"><span>Preview</span><button id="preview-close-btn" class="close-btn">&times;</button></div>
    <div class="preview-content"><iframe id="preview-iframe" class="preview"></iframe></div>
  </div>
</div>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/htmlmixed/htmlmixed.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const ui = {
    sidebar: document.getElementById('sidebar'),
    toggleExplorerBtn: document.getElementById('toggle-explorer'),
    collapseSidebarBtn: document.getElementById('collapse-sidebar'),
    treeContainer: document.getElementById('file-tree'),
    editorTabsContainer: document.getElementById('editor-tabs'),
    cmContainer: document.getElementById('cm-container'),
    imagePreviewArea: document.getElementById('image-preview-area'),
    imagePreviewImg: document.getElementById('image-preview-img'),
    folderInput: document.getElementById('folder-input'),
    zipInput: document.getElementById('zip-input'),
    runBtn: document.getElementById('run-btn-activity'),
    clearBtn: document.getElementById('clear-btn'),
    previewOverlay: document.getElementById('preview-overlay'),
    previewCloseBtn: document.getElementById('preview-close-btn'),
    previewIframe: document.getElementById('preview-iframe'),
    saveFileBtn: document.getElementById('save-file'),
    fileCount: document.getElementById('file-count')
  };

  const state = { files: {}, assetUrls: {}, currentPath: null };

  const editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
    mode: 'htmlmixed', theme: 'dracula', lineNumbers: true, autoCloseBrackets: true, viewportMargin: Infinity
  });

  const isBinaryFile = (name='') => /\.(jpe?g|png|gif|svg|webp|ico|bmp)$/i.test(name);
  const isCodeFile = (name='') => /\.(html?|css|js)$/i.test(name);

  function getModeFromPath(path = '') {
    const ext = (path.split('.').pop() || '').toLowerCase();
    if (ext === 'html' || ext === 'htm') return 'htmlmixed';
    if (ext === 'css') return 'css';
    if (ext === 'js') return 'javascript';
    return 'htmlmixed';
  }

  // Toggle sidebar visibility
  ui.toggleExplorerBtn.addEventListener('click', () => {
    ui.sidebar.classList.toggle('collapsed');
  });
  ui.collapseSidebarBtn.addEventListener('click', () => {
    ui.sidebar.classList.toggle('collapsed');
  });

  function bindRunBtn(){
    ui.runBtn.onclick = runPreview;
  }

  function runPreview() {
    if (!Object.keys(state.files).some(k => k.endsWith('index.html'))) return alert('Tidak ada index.html');
    const indexKey = Object.keys(state.files).find(k => k.endsWith('index.html'));
    let html = state.files[indexKey].text || '';
    const styleKey = Object.keys(state.files).find(k => k.endsWith('style.css'));
    const scriptKey = Object.keys(state.files).find(k => k.endsWith('script.js'));
    if (styleKey && state.files[styleKey]?.text) {
      html = html.replace(/<\/head>/i, `<style>${state.files[styleKey].text}</style></head>`);
    }
    if (scriptKey && state.files[scriptKey]?.text) {
      html = html.replace(/<\/body>/i, `<script>${state.files[scriptKey].text}<\/script></body>`);
    }
    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    ui.previewIframe.src = url;
    ui.previewOverlay.classList.add('active');
    ui.previewIframe.onload = () => URL.revokeObjectURL(url);
  }

  async function processFiles(fileList) {
    clearAll();
    for (const file of fileList) {
      const name = file.webkitRelativePath || file.name;
      const binary = isBinaryFile(name);
      state.files[name] = { file, text: binary ? undefined : await file.text(), isBinary: binary };
      if (binary) state.assetUrls[name] = URL.createObjectURL(file);
    }
    ensureDefaultFiles();
    const firstCode = Object.keys(state.files).filter(isCodeFile)[0];
    await openFile(firstCode);
    bindRunBtn();
    renderTree();
  }

  async function importZip(file) {
    clearAll();
    const zip = await JSZip.loadAsync(file);
    for (const name of Object.keys(zip.files)) {
      if (zip.files[name].dir) continue;
      if (isBinaryFile(name)) {
        const blob = await zip.files[name].async('blob');
        state.assetUrls[name] = URL.createObjectURL(blob);
        state.files[name] = { file:null, text:undefined, isBinary:true };
      } else {
        const text = await zip.files[name].async('text');
        state.files[name] = { file:null, text, isBinary:false };
      }
    }
    ensureDefaultFiles();
    const firstCode = Object.keys(state.files).filter(isCodeFile)[0];
    await openFile(firstCode);
    bindRunBtn();
    renderTree();
  }

  function ensureDefaultFiles(){
    ['index.html','style.css','script.js'].forEach(f => {
      if (!Object.keys(state.files).some(k => k.endsWith(f))) {
        state.files[f] = { text:'', isBinary:false, file:null };
      }
    });
  }

  function clearAll(){
    for (const url of Object.values(state.assetUrls)) try{ URL.revokeObjectURL(url) }catch(e){}
    Object.assign(state,{files:{},assetUrls:{},currentPath:null});
    renderTabs(); renderTree();
    editor.setValue('// Editor kosong');
    showEditor(); hideImagePreview();
    updateFileCount();
  }

  function renderTabs(){
    ui.editorTabsContainer.innerHTML = '';
    const codeKeys = Object.keys(state.files).filter(isCodeFile).sort((a,b)=>a.localeCompare(b));
    codeKeys.forEach(path=>{
      const filename = path.split('/').pop();
      const btn = document.createElement('button');
      btn.className = 'btn';
      if (path === state.currentPath) btn.classList.add('active');

      const fnameSpan = document.createElement('span');
      fnameSpan.className = 'filename';
      fnameSpan.textContent = filename;

      const closeBtn = document.createElement('button');
      closeBtn.className = 'close-btn';
      closeBtn.innerHTML = '&times;';
      closeBtn.addEventListener('click', (ev) => {
        ev.stopPropagation();
        closeFile(path);
      });

      btn.appendChild(fnameSpan);
      btn.appendChild(closeBtn);
      btn.addEventListener('click', () => openFile(path));
      ui.editorTabsContainer.appendChild(btn);
    });
  }

  function closeFile(path) {
    if (state.assetUrls[path]) {
      try{ URL.revokeObjectURL(state.assetUrls[path]); }catch(e){}
      delete state.assetUrls[path];
    }
    delete state.files[path];
    if (state.currentPath === path) {
      const remaining = Object.keys(state.files).filter(isCodeFile);
      if (remaining.length) {
        openFile(remaining[0]);
      } else {
        state.currentPath = null;
        editor.setValue('// Editor kosong');
        showEditor();
        hideImagePreview();
      }
    } else {
      renderTabs();
    }
    renderTree();
    updateFileCount();
  }

  async function openFile(path){
    if(!path || !state.files[path]) return;
    state.currentPath = path;
    renderTabs();
    if (state.files[path].isBinary) {
      hideEditor();
      ui.imagePreviewImg.src = state.assetUrls[path] || '';
      ui.imagePreviewArea.classList.add('active');
      return;
    }

    showEditor();
    hideImagePreview();

    const text = state.files[path].text ?? '';
    editor.setValue(text);
    const mode = getModeFromPath(path);
    editor.setOption('mode', mode);
    setTimeout(()=>editor.refresh(), 50);
  }

  // Build nested tree data structure from paths
  function buildTree(paths) {
    const root = {};
    paths.forEach(full => {
      const parts = full.split('/').filter(Boolean);
      let node = root;
      parts.forEach((p, idx) => {
        if (!node[p]) node[p] = { __files: {}, __children: {} };
        if (idx === parts.length - 1) {
          // this is a file
          node[p].__file = true;
          node[p].__path = full;
        } else {
          node = node[p].__children;
        }
      });
    });
    return root;
  }

  // Render tree recursively with folders and files
  function renderTree() {
    const files = Object.keys(state.files).sort((a,b)=>a.localeCompare(b));
    if (!files.length) {
      ui.treeContainer.innerHTML = '(kosong)';
      ui.fileCount.textContent = '0';
      return;
    }
    // create folder structure map
    const treeRoot = {};
    files.forEach(full => {
      const parts = full.split('/');
      let node = treeRoot;
      parts.forEach((part, idx) => {
        if (!node[part]) node[part] = { __path: parts.slice(0, idx+1).join('/'), __children: {}, __isFile: false };
        if (idx === parts.length - 1) {
          node[part].__isFile = true;
          node[part].__full = full;
        }
        node = node[part].__children;
      });
    });

    function createList(nodeObj) {
      const ul = document.createElement('ul');
      Object.keys(nodeObj).forEach(key => {
        if (key.startsWith('__')) return;
        const item = nodeObj[key];
        const li = document.createElement('li');
        const entry = document.createElement('div');
        entry.className = 'tree-item';
        // determine if folder or file
        const isFile = item.__isFile && Object.keys(item.__children).length === 0;
        if (isFile) {
          entry.innerHTML = `<i class="fa-regular fa-file"></i> <span style="overflow:hidden;text-overflow:ellipsis">${key}</span>`;
          entry.addEventListener('click', () => {
            const path = item.__full;
            if (isCodeFile(path) || state.files[path]?.isBinary) openFile(path);
          });
        } else {
          // folder
          const toggle = document.createElement('span');
          toggle.className = 'folder-toggle';
          toggle.innerHTML = '<i class="fa-solid fa-chevron-right"></i>';
          const label = document.createElement('span');
          label.className = 'folder-name';
          label.textContent = key;
          entry.appendChild(toggle);
          entry.appendChild(label);
          // nested children
          const nested = createList(item.__children);
          nested.className = 'nested collapsed';
          entry.addEventListener('click', (ev) => {
            // only toggle when clicking folder area, not inner nested file clicks
            if (nested.classList.contains('collapsed')) {
              nested.classList.remove('collapsed');
              toggle.classList.add('expanded');
            } else {
              nested.classList.add('collapsed');
              toggle.classList.remove('expanded');
            }
            ev.stopPropagation();
          });
          li.appendChild(entry);
          li.appendChild(nested);
          ul.appendChild(li);
          return;
        }
        li.appendChild(entry);
        ul.appendChild(li);
      });
      return ul;
    }

    // Convert treeRoot which currently nests children under __children into a simpler nested object
    function toRenderable(node) {
      const out = {};
      Object.keys(node).forEach(k => {
        out[k] = { __children: {} , __isFile: node[k].__isFile, __full: node[k].__full };
        // recursively add children
        if (node[k].__children) {
          out[k].__children = toRenderable(node[k].__children);
        }
      });
      return out;
    }

    const renderable = toRenderable(treeRoot);
    ui.treeContainer.innerHTML = '';
    ui.treeContainer.appendChild(createList(renderable));
    ui.fileCount.textContent = files.length;
  }

  function hideImagePreview(){
    ui.imagePreviewArea.classList.remove('active');
    ui.imagePreviewImg.src = '';
  }
  function showEditor(){
    document.querySelector('.cm-container').style.display = 'block';
  }
  function hideEditor(){
    document.querySelector('.cm-container').style.display = 'none';
  }

  // update count small helper
  function updateFileCount(){ ui.fileCount.textContent = Object.keys(state.files).length; }

  // Events
  ui.folderInput.onchange = e => {
    if (e.target.files && e.target.files.length) processFiles(e.target.files);
    // reset input so same folder can be re-selected later
    e.target.value = '';
  };
  ui.zipInput.onchange = e => {
    if (e.target.files && e.target.files[0]) importZip(e.target.files[0]);
    e.target.value = '';
  };
  ui.clearBtn.onclick = clearAll;
  ui.saveFileBtn.onclick = () => {
    if(state.currentPath && state.files[state.currentPath] && !state.files[state.currentPath].isBinary) {
      state.files[state.currentPath].text = editor.getValue();
      alert('File saved ke memori (session).');
    }
  };
  ui.previewCloseBtn.onclick = () => ui.previewOverlay.classList.remove('active');
  bindRunBtn();

  // Init default files and open index
  state.files['index.html']={text:'<!doctype html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <title>Index</title>\n</head>\n<body>\n  <h1>Halo</h1>\n</body>\n</html>',isBinary:false,file:null};
  state.files['style.css']={text:'/* style.css */\nbody{font-family:Arial}',isBinary:false,file:null};
  state.files['script.js']={text:'// script.js\nconsole.log(\"hello\");',isBinary:false,file:null};

  (async function awaitOpenDefault(){
    const idx = Object.keys(state.files).find(k=>k.endsWith('index.html')) || Object.keys(state.files).filter(isCodeFile)[0];
    await openFile(idx);
    renderTabs();
    renderTree();
    updateFileCount();
  })();

  // drag & drop support for files and zip
  window.addEventListener('dragover', e => e.preventDefault());
  window.addEventListener('drop', async (e) => {
    e.preventDefault();
    const items = e.dataTransfer.files;
    if (!items || !items.length) return;
    // if single zip file -> import zip
    if (items.length === 1 && items[0].name.toLowerCase().endsWith('.zip')) {
      await importZip(items[0]);
      return;
    }
    // otherwise treat as folder/file list (if webkitRelativePath available it will be used)
    await processFiles(items);
  });

});
</script>
</body>
</html>
