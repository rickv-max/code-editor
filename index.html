<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Editor + Folder Upload (In-memory, No LocalStorage)</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/dracula.min.css" />

<style>
  :root{--bg:#111;--panel:#1f1f1f;--muted:#9aa0a6;--accent:#0ea5e9;--text:#e6eef6}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,Segoe UI,system-ui;min-height:100vh;display:flex;flex-direction:column}
  header{display:flex;gap:10px;padding:12px;background:linear-gradient(90deg,#0b1220 0,#12151a 100%);align-items:center}
  header h1{margin:0;font-size:16px; white-space: nowrap;}
  .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
  button.btn{background:var(--panel);color:var(--text);border:1px solid #2a2a2a;padding:8px 10px;border-radius:6px;cursor:pointer}
  main{display:flex;flex:1;gap:12px;padding:12px;align-items:stretch}
  .left{width:520px;display:flex;flex-direction:column;gap:12px; flex-shrink: 0;}
  .tabs{display:flex;gap:6px}
  .tabs button{flex:1}
  .editor-wrap{flex:1;background:var(--panel);border-radius:8px;overflow:hidden;display:flex;flex-direction:column}
  .cm-container{min-height:250px; flex: 1}
  .file-tree{background:#0f1519;color:var(--muted);padding:10px;border-radius:8px;height:250px;overflow:auto;font-size:13px}
  .file-tree ul{list-style:none;padding-left:6px;margin:0}
  .file-tree li{padding:4px 6px;border-radius:4px;cursor:default; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
  .file-tree li:hover{background:#111827;color:var(--text)}
  .preview-btn{background:linear-gradient(90deg,var(--accent),#0369a1);border:0;color:white;padding:8px 12px;border-radius:6px;cursor:pointer}
  .right{flex:1;display:flex;flex-direction:column;gap:8px; min-width: 0;}
  .preview-area{flex:1;background:var(--panel);border-radius:8px;padding:10px;display:flex;flex-direction:column}
  .frames{display:flex;gap:8px;align-items:center}
  iframe.preview{flex:1;border:0;width:100%;min-height:400px;border-radius:6px;background:white}
  .note{color:var(--muted);font-size:13px}
  input[type=file]{display:none}

  /* ================================= */
  /* === BAGIAN RESPONSIVE BARU === */
  /* ================================= */

  /* Untuk Tablet dan layar yang lebih kecil (di bawah 900px) */
  @media (max-width: 900px) {
    main {
      /* Ubah layout utama menjadi satu kolom vertikal */
      flex-direction: column;
    }

    .left {
      /* Hapus lebar tetap dan buat menjadi lebar penuh */
      width: 100%;
    }

    .file-tree {
      /* Kurangi tinggi file tree agar tidak memakan banyak tempat */
      height: 200px;
    }
  }

  /* Untuk Ponsel dan layar yang sangat kecil (di bawah 600px) */
  @media (max-width: 600px) {
    header {
      /* Buat header juga menjadi vertikal */
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
    }

    .controls {
      /* Hapus margin dan biarkan tombol-tombolnya memenuhi lebar */
      margin-left: 0;
      flex-wrap: wrap; /* Izinkan tombol untuk pindah ke baris baru jika tidak muat */
    }

    .note {
      /* Sembunyikan beberapa catatan teks agar UI lebih bersih */
      display: none;
    }

    /* Sembunyikan teks pada tombol upload, hanya sisakan ikon */
    .controls .btn span {
      display: none;
    }
    .controls .btn .fa-solid {
      margin-right: 0;
    }
  }
</style>
</head>
<body>
<header>
  <h1>Code Editor — +Folder (In-memory)</h1>
  <div class="controls">
    <label class="btn" title="Upload folder">
      <i class="fa-solid fa-folder-plus"></i>&nbsp;<span class="btn-text">+Folder</span>
      <input id="folder-input" type="file" webkitdirectory multiple />
    </label>
    <label class="btn" title="Upload ZIP">
      <i class="fa-solid fa-file-zipper"></i>&nbsp;<span class="btn-text">Import .zip</span>
      <input id="zip-input" type="file" accept=".zip" />
    </label>
    <button id="clear-btn" class="btn" title="Clear semua (in-memory)">Clear</button>
    <button id="run-btn" class="preview-btn"><i class="fa-solid fa-play"></i> Run Preview</button>
  </div>
</header>

<main>
  <div class="left">
    <div class="tabs">
      <button id="tab-html" class="btn">index.html</button>
      <button id="tab-css" class="btn">style.css</button>
      <button id="tab-js" class="btn">script.js</button>
    </div>

    <div class="editor-wrap">
      <div class="cm-container"><textarea id="code-editor"></textarea></div>
      <div style="padding:10px;display:flex;gap:8px;align-items:center">
        <button id="save-file" class="btn"><i class="fa-solid fa-save"></i> Save</button>
        <div class="note">Tip: pilih file di file-tree untuk edit. Tidak ada LocalStorage — semua di memori.</div>
      </div>
    </div>

    <div class="file-tree" id="file-tree">
      <strong>Project Files (in-memory)</strong>
      <ul id="tree-list"><li style="color:var(--text)">(kosong) Unggah folder atau zip...</li></ul>
    </div>
  </div>

  <div class="right">
    <div class="preview-area">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Preview</strong> <span class="note"> (iframe menggunakan srcdoc)</span></div>
        <div class="frames">
          <button id="desktop-view" class="btn active">Desktop</button>
          <button id="mobile-view" class="btn">Mobile</button>
        </div>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;align-items:flex-start; flex: 1;">
        <iframe id="preview-iframe" class="preview"></iframe>
      </div>

    </div>
  </div>
</main>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
// === SCRIPT ANDA TIDAK SAYA UBAH, TETAP SAMA SEPERTI ASLINYA ===
document.addEventListener('DOMContentLoaded', () => {
  // ELEMEN
  const folderInput = document.getElementById('folder-input');
  const zipInput = document.getElementById('zip-input');
  const treeList = document.getElementById('tree-list');
  const runBtn = document.getElementById('run-btn');
  const clearBtn = document.getElementById('clear-btn');
  const previewIframe = document.getElementById('preview-iframe');
  const saveFileBtn = document.getElementById('save-file');
  const tabs = { html: document.getElementById('tab-html'), css: document.getElementById('tab-css'), js: document.getElementById('tab-js') };

  // STATE (in-memory, no localStorage)
  const state = {
    files: {},        // relativePath -> { file, text, isBinary }
    assetUrls: {},    // pathOrFilename -> blobUrl
    currentPath: null // currently open file path in editor
  };

  // CODEMIRROR
  const editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
    mode: 'xml', theme: 'dracula', lineNumbers: true, autoCloseBrackets: true
  });

  // UTIL
  const isBinaryFile = (name) => /\.(jpe?g|png|gif|svg|webp|mp4|webm|ogg|ico|woff2?)$/i.test(name);

  // RE-RENDER FILE TREE
  function renderTree() {
    treeList.innerHTML = '';
    const keys = Object.keys(state.files).sort();
    if (!keys.length) {
      treeList.innerHTML = '<li style="color:var(--muted)">(kosong) Unggah folder atau zip...</li>';
      return;
    }
    keys.forEach(k => {
      const li = document.createElement('li');
      li.textContent = k;
      li.title = k;
      li.onclick = async () => {
        state.currentPath = k;
        // kalau teks, tampilkan isinya
        if (!state.files[k].isBinary) {
          if (state.files[k].text === undefined) {
            // lazy-read
            state.files[k].text = await state.files[k].file.text();
          }
          const mode = k.match(/\.css$/i) ? 'css' : (k.match(/\.js$/i) ? 'javascript' : 'xml');
          editor.setOption('mode', mode);
          editor.setValue(state.files[k].text || '');
        } else {
          editor.setOption('mode', 'xml');
          editor.setValue(`(binary file) ${k}`);
        }
      };
      treeList.appendChild(li);
    });
  }

  // HAPUS semua blob URLs & files
  function clearAll() {
    Object.values(state.assetUrls).forEach(URL.revokeObjectURL);
    state.assetUrls = {};
    state.files = {};
    state.currentPath = null;
    editor.setValue('');
    renderTree();
  }

  clearBtn.onclick = () => {
    if (confirm('Hapus semua file yang ada di memori?')) clearAll();
  };

  // PROSES UPLOAD FOLDER (webkitdirectory)
  folderInput.addEventListener('change', async (e) => {
    const files = Array.from(e.target.files || []);
    if (!files.length) return;
    // revoke existing blobs
    Object.values(state.assetUrls).forEach(URL.revokeObjectURL);
    state.assetUrls = {};

    for (const file of files) {
      // webkitRelativePath tersedia ketika pakai webkitdirectory
      const relative = file.webkitRelativePath || file.name;
      const entry = { file, isBinary: isBinaryFile(relative) };
      // jika text file, baca text sekarang supaya editor bisa pakai
      if (!entry.isBinary) {
        try { entry.text = await file.text(); } catch(e){ entry.text = ''; }
      } else {
        // buat blob url dan simpan dengan BOTH relative path & basename
        const blobUrl = URL.createObjectURL(file);
        state.assetUrls[relative] = blobUrl;
        state.assetUrls[relative.split('/').pop()] = blobUrl;
      }
      state.files[relative] = entry;
    }
    renderTree();
    // auto-open index.html jika ada
    const htmlKey = Object.keys(state.files).find(f => /index\.html?$/.test(f));
    if (htmlKey) {
        document.getElementById('tab-html').click();
    }
    e.target.value = '';
  });

  // ZIP import (opsional) - baca file2 di dalam zip dan masukkan ke state.files
  zipInput.addEventListener('change', async (e) => {
    const f = e.target.files[0];
    if (!f) return;
    try {
      const jszip = await JSZip.loadAsync(f);
      // clear previous
      Object.values(state.assetUrls).forEach(URL.revokeObjectURL);
      state.assetUrls = {};
      state.files = {};
      const promises = [];
      jszip.forEach((relPath, entry) => {
        if (entry.dir) return;
        const p = (async () => {
          const isBin = isBinaryFile(relPath);
          if (isBin) {
            const blob = await entry.async('blob');
            const blobUrl = URL.createObjectURL(blob);
            state.assetUrls[relPath] = blobUrl;
            state.assetUrls[relPath.split('/').pop()] = blobUrl;
            // create a File-like object for consistency (Blob doesn't have name+webkitRelativePath)
            const fileObj = new File([blob], relPath.split('/').pop(), { type: blob.type });
            state.files[relPath] = { file: fileObj, isBinary: true };
          } else {
            const txt = await entry.async('string');
            // create fake File object for text for potential save/export later
            const fileObj = new File([txt], relPath.split('/').pop(), { type: 'text/plain' });
            state.files[relPath] = { file: fileObj, text: txt, isBinary: false };
          }
        })();
        promises.push(p);
      });
      await Promise.all(promises);
      renderTree();
       const htmlKey = Object.keys(state.files).find(f => /index\.html?$/.test(f));
        if (htmlKey) {
            document.getElementById('tab-html').click();
        }
    } catch(err) {
      console.error('ZIP error', err);
      alert('Gagal memproses zip');
    } finally {
      e.target.value = '';
    }
  });

  // SAVE file yang sedang diedit (update state.files[currentPath].text)
  saveFileBtn.addEventListener('click', () => {
    if (!state.currentPath) return alert('Pilih file dulu di file-tree');
    if (state.files[state.currentPath].isBinary) return alert('Tidak bisa menyimpan file biner lewat editor.');
    state.files[state.currentPath].text = editor.getValue();
    alert('Tersimpan (in-memory). Tekan Run Preview untuk melihat perubahan.');
  });

  // TAB switch sederhana
  tabs.html.onclick = () => {
    // prefer index.html di tree
    const candidate = Object.keys(state.files).find(k => /index\.html?$/i.test(k));
    if (candidate) {
      state.currentPath = candidate;
      editor.setOption('mode','xml');
      editor.setValue(state.files[candidate].text || '');
    } else {
      state.currentPath = 'index.html';
      editor.setOption('mode','xml');
      editor.setValue('<h1>index.html belum ada</h1>');
    }
  };
  tabs.css.onclick = () => {
    const candidate = Object.keys(state.files).find(k => /style\.css$/i.test(k));
    if (candidate) { state.currentPath = candidate; editor.setOption('mode','css'); editor.setValue(state.files[candidate].text||''); }
    else { state.currentPath = 'style.css'; editor.setOption('mode','css'); editor.setValue('/* style.css belum ada */'); }
  };
  tabs.js.onclick = () => {
    const candidate = Object.keys(state.files).find(k => /script\.js$/i.test(k));
    if (candidate) { state.currentPath = candidate; editor.setOption('mode','javascript'); editor.setValue(state.files[candidate].text||''); }
    else { state.currentPath = 'script.js'; editor.setOption('mode','javascript'); editor.setValue('// script.js belum ada'); }
  };

  // BUILD SOURCE FOR PREVIEW: ambil index.html, style.css, script.js dari state.files; fallback ke editor jika tidak ada
  async function buildPreviewSource() {
    let html = '<h1>Project kosong</h1>', css = '', js = '';
    
    const findKey = (regex) => Object.keys(state.files).find(k => regex.test(k));
    const readFile = async (key) => state.files[key]?.text ?? (await state.files[key]?.file.text()) ?? '';

    const htmlKey = findKey(/index\.html?$/i);
    const cssKey = findKey(/style\.css$/i);
    const jsKey = findKey(/script\.js$/i);
    
    if (htmlKey) html = await readFile(htmlKey);
    if (cssKey) css = await readFile(cssKey);
    if (jsKey) js = await readFile(jsKey);

    const keys = Object.keys(state.assetUrls || {}).sort((a,b) => b.length - a.length);

    let processedHtml = html;
    for (const k of keys) {
        const url = state.assetUrls[k];
        if (!url) continue;
        const esc = k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(esc, 'g');
        processedHtml = processedHtml.replace(regex, url);
    }

    const source = `<!doctype html>
<html lang="id">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>${css}</style>
</head>
<body>
${processedHtml}
<script>${js}<\/script>
</body>
</html>`;
    return source;
  }

  // RUN PREVIEW
  runBtn.addEventListener('click', async () => {
    try {
      const src = await buildPreviewSource();
      previewIframe.srcdoc = src;
    } catch (e) {
      console.error('Preview error', e);
      alert('Gagal membangun preview. Cek console.');
    }
  });

  // basic drag-n-drop folder area (optional)
  document.body.addEventListener('dragover', (e)=>{ e.preventDefault(); });
  document.body.addEventListener('drop', async (e)=> {
    e.preventDefault();
    const files = Array.from(e.dataTransfer.files || []);
    if (!files.length) return;
    
    const entries = [];
    for(const item of e.dataTransfer.items) {
      if(item.kind === 'file') {
        const entry = item.webkitGetAsEntry();
        if(entry.isDirectory) {
          // You need a recursive function to read directories, skipping for simplicity here
        } else {
          entries.push(item.getAsFile());
        }
      }
    }
    // Simple file list processing for now
    const processPromises = entries.map(async file => {
       const relative = file.webkitRelativePath || file.name;
       const entry = { file: file, isBinary: isBinaryFile(relative) };
        if (!entry.isBinary) {
            try { entry.text = await file.text(); } catch(err) { entry.text = ''; }
        } else {
            const blobUrl = URL.createObjectURL(file);
            state.assetUrls[relative] = blobUrl;
            state.assetUrls[relative.split('/').pop()] = blobUrl;
        }
        state.files[relative] = entry;
    });
    
    await Promise.all(processPromises);
    renderTree();
  });

  // initial render
  renderTree();

  // revoke blob URLs when page unloads
  window.addEventListener('beforeunload', () => {
    Object.values(state.assetUrls).forEach(URL.revokeObjectURL);
  });
});
</script>
</body>
</html>
