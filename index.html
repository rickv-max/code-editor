<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>Code Editor - ZIP Project Import/Export</title>
<!-- FONT AWESOME & CODEMIRROR CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/dracula.min.css" />
<style>
  :root {
    --bg-1: #1e1e1e; --bg-2: #252526; --bg-3: #333333; --border: #444;
    --text: #ccc; --accent: #007acc; --preview-bg: #3c3c3c;
  }
  * { box-sizing: border-box; }
  html, body {
    margin: 0; padding: 0; height: 100%; width: 100%;
    font-family: -apple-system, 'Segoe UI', sans-serif;
    background-color: var(--bg-1); color: var(--text);
    display: flex; flex-direction: column; overflow: hidden;
  }

  /* --- STRUKTUR UTAMA (MOBILE FIRST) --- */
  #main-content { flex: 1; overflow: hidden; position: relative; }
  #bottom-nav {
    width: 100%; height: 55px; background-color: var(--bg-2);
    display: flex; justify-content: space-around; align-items: center;
    border-top: 1px solid var(--border); order: 2; flex-shrink: 0;
  }
  #bottom-nav .nav-btn {
    background: none; border: none; color: var(--text);
    display: flex; flex-direction: column; align-items: center;
    gap: 4px; font-size: 10px; height: 100%; padding: 5px 12px; cursor: pointer;
  }
  #bottom-nav .nav-btn i { font-size: 20px; }
  
  .view-container {
    position: absolute; inset: 0; height: 100%; width: 100%;
    display: none; flex-direction: column; background-color: var(--bg-1);
  }
  .view-container.active { display: flex; }

  /* Tampilan Editor */
  #editor-view .editor-header {
    display: flex; background-color: var(--bg-2); flex-shrink: 0; overflow-x: auto;
  }
  #editor-view .editor-header button {
    background: none; border: none; color: var(--text); padding: 10px 15px;
    font-weight: 500; cursor: pointer; border-right: 1px solid var(--border);
    border-bottom: 2px solid transparent; white-space: nowrap;
  }
  #editor-view .editor-header button.active { color: white; background-color: var(--bg-1); border-bottom-color: var(--accent); }
  #editor-view .cm-container { flex: 1; position: relative; }
  .CodeMirror { position: absolute; inset: 0; height: 100%; font-size: 14px; }

  /* Tampilan File Manager */
  #files-view { background-color: var(--bg-2); }
  .files-header { display: flex; align-items: center; padding: 0 10px; height: 50px; background-color: var(--bg-1); border-bottom: 1px solid var(--border); }
  .files-header .back-btn { background: none; border: none; color: var(--accent); font-size: 16px; font-weight: 600; padding: 10px; }
  .panel-actions { padding: 15px; }
  .panel-actions button {
    width: 100%; background-color: var(--accent); color: white; display: flex;
    align-items: center; justify-content: center; gap: 10px; border: none;
    padding: 12px; border-radius: 6px; cursor: pointer; margin-bottom: 10px;
    font-weight: 600; font-size: 16px;
  }

  /* Pratinjau (Overlay) dan styling bingkai (sama seperti sebelumnya) */
  #preview-overlay{position:fixed;inset:0;z-index:1000;display:none;flex-direction:column;background:var(--preview-bg)}#preview-overlay.active{display:flex}.preview-header{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background-color:var(--bg-2);border-bottom:1px solid var(--border);flex-shrink:0}.preview-header .back-btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;font-weight:600}.preview-controls button{background:none;border:1px solid var(--text);color:var(--text);padding:5px;width:38px;border-radius:4px;margin-left:5px}.preview-controls button.active{background:var(--accent);border-color:var(--accent)}.preview-content{flex:1;display:flex;align-items:center;justify-content:center;overflow:auto;padding:15px}#desktop-frame{min-width:800px;width:95%;max-width:1200px;aspect-ratio:16/9;background:#fff;border-radius:8px;box-shadow:0 5px 20px rgba(0,0,0,.3);display:flex;flex-direction:column;margin:auto}#iphone-frame{width:280px;height:580px;flex-shrink:0;background:#111;border:4px solid #333;border-radius:40px;padding:10px;box-shadow:0 5px 20px rgba(0,0,0,.3);display:none;position:relative}.window-header{display:flex;align-items:center;padding:8px;background:#e0e0e0;border-bottom:1px solid #ccc;border-top-left-radius:8px;border-top-right-radius:8px;flex-shrink:0}.window-controls{display:flex;gap:6px}.control-btn{width:12px;height:12px;border-radius:50%}.control-btn.close{background:#ff5f57}.control-btn.minimize{background:#ffbd2e}.control-btn.maximize{background:#28c940}.address-bar{flex:1;background:#fff;margin:0 20px;padding:4px 8px;border-radius:4px;color:#555;font-size:12px}#desktop-preview,#mobile-preview{width:100%;height:100%;border:none}.iphone-screen{width:100%;height:100%;background:#fff;border-radius:30px;position:relative;overflow:hidden}.iphone-notch{position:absolute;top:0;left:50%;transform:translateX(-50%);width:130px;height:25px;background:#111;border-bottom-left-radius:15px;border-bottom-right-radius:15px;z-index:10}
</style>
</head>
<body>
<main id="main-content">
  <div id="editor-view" class="view-container active">
    <div class="editor-header">
      <button id="tab-html" class="active">index.html</button>
      <button id="tab-css">style.css</button>
      <button id="tab-js">script.js</button>
    </div>
    <div class="cm-container"><textarea id="code-editor"></textarea></div>
  </div>
  <div id="files-view" class="view-container">
    <div class="files-header">
        <button id="files-back-btn" class="back-btn"><i class="fa-solid fa-chevron-left"></i> Kembali</button>
    </div>
    <div class="panel-actions">
      <!-- TOMBOL INI SEKARANG UNTUK IMPOR ZIP -->
      <button id="import-zip-btn"><i class="fa-solid fa-file-zipper"></i> Impor Proyek (.zip)...</button>
      <button id="export-zip-btn"><i class="fa-solid fa-download"></i> Ekspor Proyek (.zip)</button>
    </div>
  </div>
</main>
<nav id="bottom-nav">
  <button id="nav-editor" class="nav-btn active" title="Editor"><i class="fa-solid fa-code"></i><span>Editor</span></button>
  <button id="nav-files" class="nav-btn" title="Files"><i class="fa-solid fa-folder-open"></i><span>Files</span></button>
  <button id="nav-run" class="nav-btn" title="Run Preview"><i class="fa-solid fa-play"></i><span>Run</span></button>
</nav>
<div id="preview-overlay">
  <!-- Konten pratinjau lengkap -->
  <div class="preview-header"><button id="preview-back-btn" class="back-btn"><i class="fa-solid fa-chevron-left"></i> Tutup</button><div class="preview-controls"><button id="desktop-view-btn" class="active" title="Desktop"><i class="fa-solid fa-desktop"></i></button><button id="mobile-view-btn" title="Mobile"><i class="fa-solid fa-mobile-alt"></i></button></div></div><div class="preview-content"><div id="desktop-frame"><div class="window-header"><div class="window-controls"><span class="control-btn close"></span><span class="control-btn minimize"></span><span class="control-btn maximize"></span></div><div class="address-bar"><span>localhost</span></div></div><iframe id="desktop-preview"></iframe></div><div id="iphone-frame"><div class="iphone-screen"><div class="iphone-notch"></div><iframe id="mobile-preview"></iframe></div></div></div>
</div>
<input type="file" id="zip-importer" accept=".zip" style="display:none;" />
<!-- SCRIPT LIBRARIES -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/css/css.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // === ELEMEN ===
    const elements = {
      nav: { editor: document.getElementById('nav-editor'), files: document.getElementById('nav-files'), run: document.getElementById('nav-run') },
      views: { editor: document.getElementById('editor-view'), files: document.getElementById('files-view') },
      editorTabs: { html: document.getElementById('tab-html'), css: document.getElementById('tab-css'), js: document.getElementById('tab-js') },
      files: {
        backBtn: document.getElementById('files-back-btn'),
        importBtn: document.getElementById('import-zip-btn'),
        exportBtn: document.getElementById('export-zip-btn'),
        importerInput: document.getElementById('zip-importer'),
      },
      preview: {
        overlay: document.getElementById('preview-overlay'), backBtn: document.getElementById('preview-back-btn'),
        desktopBtn: document.getElementById('desktop-view-btn'), mobileBtn: document.getElementById('mobile-view-btn'),
        desktopFrame: document.getElementById('desktop-frame'), mobileFrame: document.getElementById('iphone-frame'),
        desktopIframe: document.getElementById('desktop-preview'), mobileIframe: document.getElementById('mobile-preview'),
      }
    };
    
    // === STATE ===
    const defaultCode = {
      html: `<h1>Selamat Datang!</h1>\n<p>Klik tombol Files untuk impor proyek .zip</p>`,
      css: `body { padding: 1rem; font-family: sans-serif; text-align: center; }`,
      js: `console.log("Editor siap!");`
    };
    const state = { currentLanguage: 'html', codeData: { ...defaultCode }, assetUrls: {} };

    // === INISIALISASI EDITOR ===
    const editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
      mode: 'xml', theme: 'dracula', lineNumbers: true, autoCloseBrackets: true,
    });
    editor.setValue(state.codeData.html);
    editor.on('change', () => { state.codeData[state.currentLanguage] = editor.getValue(); });

    // === FUNGSI INTI ===
    const switchMainView = (viewName) => {
        document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
        elements.views[viewName].classList.add('active');
        if (viewName === 'editor') editor.refresh();
    };
    
    const switchLanguage = (lang) => {
      state.currentLanguage = lang;
      Object.values(elements.editorTabs).forEach(tab => tab.classList.remove('active'));
      elements.editorTabs[lang].classList.add('active');
      editor.setOption('mode', lang === 'html' ? 'xml' : lang);
      editor.setValue(state.codeData[lang]);
      editor.focus();
    };
    
    // ==========================================================
    // === KODE YANG DIPERBAIKI ADA DI FUNGSI DI BAWAH INI ===
    // ==========================================================
    const togglePreview = (show) => {
    if (show) {
        let processedHtml = state.codeData.html;
        let processedCss = state.codeData.css;

        const escapeRegExp = (string) => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

        for (const [path, url] of Object.entries(state.assetUrls)) {
            // Ganti di HTML (src / href)
            const regexHtml = new RegExp(escapeRegExp(path), 'g');
            processedHtml = processedHtml.replace(regexHtml, url);

            // Ganti di CSS (url(...))
            const regexCss = new RegExp(escapeRegExp(path), 'g');
            processedCss = processedCss.replace(regexCss, url);
        }

        const source = `
            <!DOCTYPE html>
            <html lang="id">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <style>${processedCss}</style>
            </head>
            <body>
                ${processedHtml}
                <script>${state.codeData.js}<\/script>
            </body>
            </html>
        `;

        elements.preview.desktopIframe.srcdoc = source;
        elements.preview.mobileIframe.srcdoc = source;
    }
    elements.preview.overlay.classList.toggle('active', show);
};

    const handleZipImport = async (file) => {
    if (!file) return;
    JSZip.loadAsync(file).then(async (zip) => {
        // Hapus aset lama
        Object.values(state.assetUrls).forEach(URL.revokeObjectURL);
        state.assetUrls = {};

        // Proses file teks
        const htmlFile = zip.file(/index\.html?$/i)[0];
        const cssFile = zip.file(/style\.css$/i)[0];
        const jsFile = zip.file(/script\.js$/i)[0];

        if (htmlFile) state.codeData.html = await htmlFile.async('string');
        if (cssFile) state.codeData.css = await cssFile.async('string');
        if (jsFile) state.codeData.js = await jsFile.async('string');

        // Proses aset gambar
        const imagePromises = [];
        zip.forEach((relativePath, zipEntry) => {
            if (/\.(jpe?g|png|gif|svg|webp)$/i.test(relativePath) && !relativePath.startsWith('__MACOSX/')) {
                imagePromises.push(
                    zipEntry.async('blob').then(blob => {
                        const fileName = relativePath.split('/').pop();
                        // Simpan dengan path asli dan nama file
                        state.assetUrls[relativePath] = URL.createObjectURL(blob);
                        state.assetUrls[fileName] = URL.createObjectURL(blob);
                    })
                );
            }
        });
        await Promise.all(imagePromises);

        switchLanguage('html');
        switchMainView('editor');
        alert(`Proyek ${file.name} berhasil diimpor!`);
    }).catch(err => {
        console.error("Gagal memproses zip:", err);
        alert("Gagal memproses file zip. Pastikan formatnya benar.");
    });
};

    // === EVENT LISTENERS ===
    elements.nav.editor.onclick = () => switchMainView('editor');
    elements.nav.files.onclick = () => switchMainView('files');
    elements.files.backBtn.onclick = () => switchMainView('editor');
    elements.nav.run.onclick = () => togglePreview(true);
    elements.editorTabs.html.onclick = () => switchLanguage('html');
    elements.editorTabs.css.onclick = () => switchLanguage('css');
    elements.editorTabs.js.onclick = () => switchLanguage('js');
    elements.preview.backBtn.onclick = () => togglePreview(false);
    
    elements.files.exportBtn.onclick = () => {
        const zip = new JSZip();
        zip.file("index.html", state.codeData.html);
        zip.file("style.css", state.codeData.css);
        zip.file("script.js", state.codeData.js);
        // Perlu menambahkan aset kembali ke zip jika ingin diekspor ulang,
        // namun itu memerlukan logika yang lebih kompleks untuk mengambil blob dari object URL.
        // Untuk saat ini, ekspor hanya kode.
        zip.generateAsync({type:"blob"}).then(content => saveAs(content, "proyek-kode.zip"));
    };
    elements.files.importBtn.onclick = () => elements.files.importerInput.click();
    elements.files.importerInput.onchange = (e) => {
        handleZipImport(e.target.files[0]);
        e.target.value = ''; // Reset input agar bisa impor file yang sama lagi
    };

    // === INISIALISASI AWAL ===
    const switchPreviewDevice = (device) => { 
        const isDesktop = device === 'desktop'; 
        elements.preview.desktopFrame.style.display = isDesktop ? 'flex' : 'none'; 
        elements.preview.mobileFrame.style.display = isDesktop ? 'none' : 'flex'; 
        elements.preview.desktopBtn.classList.toggle('active', isDesktop); 
        elements.preview.mobileBtn.classList.toggle('active', !isDesktop); 
    };
    elements.preview.desktopBtn.onclick = () => switchPreviewDevice('desktop');
    elements.preview.mobileBtn.onclick = () => switchPreviewDevice('mobile');

    const init = () => {
        switchMainView('editor');
        switchPreviewDevice('desktop');
        elements.nav.editor.classList.remove('active'); // Editor adalah default, jadi tombol nav tidak perlu aktif
        document.querySelector('#bottom-nav .nav-btn[title="Editor"]').onclick = () => switchMainView('editor');
        document.getElementById('nav-editor').style.display = 'flex'; // Tampilkan kembali tombol editor
    };

    init();
});
</script>

</body>
</html>
